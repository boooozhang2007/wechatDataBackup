<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>wechatDataBackup</title>
  <script type="module" crossorigin src="/assets/index.8be36b27.js"></script>
  <link rel="stylesheet" href="/assets/index.00f6955e.css">
</head>
<body >
<div id="root"></div>

<!-- LLM Export Extension -->
<style>
    .llm-fab { position: fixed; bottom: 20px; right: 20px; z-index: 2147483647; }
    .llm-btn { padding: 12px 24px; background-color: #07C160; color: white; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-family: sans-serif; font-size: 16px; font-weight: bold; transition: transform 0.2s, background-color 0.3s; }
    .llm-btn:hover { background-color: #06ad56; transform: scale(1.05); }
    .llm-btn:active { transform: scale(0.95); }
    .llm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2147483647; font-family: sans-serif; backdrop-filter: blur(2px); }
    .llm-content { background-color: white; margin: 5% auto; padding: 25px; width: 500px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; max-height: 90vh; overflow-y: auto; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .llm-group { margin-bottom: 15px; }
    .llm-label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 14px; }
    .llm-input, .llm-select, .llm-textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: border-color 0.3s; }
    .llm-input:focus, .llm-select:focus, .llm-textarea:focus { border-color: #07C160; outline: none; }
    .llm-actions { text-align: right; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    .llm-cancel { padding: 10px 20px; margin-right: 10px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; color: #333; font-weight: bold; }
    .llm-submit { padding: 10px 20px; background-color: #07C160; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .llm-submit:disabled { background-color: #8fdcb4; cursor: not-allowed; }
    .llm-cancel:hover { background-color: #e0e0e0; }
    .llm-submit:hover:not(:disabled) { background-color: #06ad56; }
</style>

<div class="llm-fab">
    <button class="llm-btn" onclick="openLLMModal()">ğŸ¤– LLM å¯¼å‡ºå·¥å…·</button>
</div>

<div id="llm-modal" class="llm-modal">
    <div class="llm-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <h2 style="margin: 0; color: #333; font-size: 18px;">å¯¼å‡ºèŠå¤©è®°å½• (LLMè®­ç»ƒ)</h2>
            <span style="cursor: pointer; font-size: 20px; color: #999;" onclick="closeLLMModal()">Ã—</span>
        </div>
        
        <div class="llm-group">
            <label class="llm-label">é€‰æ‹©è”ç³»äºº (ä»…æ˜¾ç¤ºå‰500ä¸ª): <a href="#" onclick="loadContacts()" style="font-size: 12px; color: #07C160; text-decoration: none;">ğŸ”„ åˆ·æ–°åˆ—è¡¨</a></label>
            <input type="text" id="llm-search" placeholder="ğŸ” æœç´¢è”ç³»äºº..." class="llm-input" style="margin-bottom: 8px;" oninput="filterContacts()">
            <select id="llm-wxid" class="llm-select" size="8" style="height: auto;">
                <option value="">-- å¯¼å‡ºæ‰€æœ‰è”ç³»äºº (æ…ç”¨) --</option>
            </select>
        </div>

        <div class="llm-group">
            <label class="llm-label">System Prompt:</label>
            <textarea id="llm-prompt" class="llm-textarea" rows="3">ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹</textarea>
        </div>

        <div class="llm-group">
            <label class="llm-label">Bot Role Name (ä½ çš„è§’è‰²):</label>
            <input type="text" id="llm-botname" value="æˆ‘(è®­ç»ƒè‡ªå·±)" class="llm-input">
            <small style="color: #666; font-size: 12px;">å¦‚æœæ˜¯"æˆ‘(è®­ç»ƒè‡ªå·±)"ï¼Œåˆ™ä½ çš„æ¶ˆæ¯ä¸ºAssistantï¼Œå¯¹æ–¹ä¸ºUserã€‚</small>
        </div>

        <div class="llm-group">
            <label class="llm-label">ä¼šè¯åˆ†å‰²é—´éš” (åˆ†é’Ÿ):</label>
            <input type="number" id="llm-gap" value="30" class="llm-input">
        </div>

        <div class="llm-group">
            <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px; user-select: none;">
                <input type="checkbox" id="llm-clean" checked style="margin-right: 8px; width: 18px; height: 18px;"> 
                <span>æ¸…æ´—æ•æ„Ÿä¿¡æ¯ (æ‰‹æœº/èº«ä»½è¯/é‚®ç®±/URL)</span>
            </label>
        </div>

        <div class="llm-group">
            <label class="llm-label">å¯¼å‡ºæ–‡ä»¶è·¯å¾„ (.jsonl):</label>
            <input type="text" id="llm-path" placeholder="D:\wechat_export.jsonl" class="llm-input">
            <small style="color: #999; font-size: 12px;">è¯·ç¡®ä¿è·¯å¾„æ‰€åœ¨çš„æ–‡ä»¶å¤¹å­˜åœ¨ä¸”å¯å†™</small>
        </div>

        <div class="llm-actions">
            <button class="llm-cancel" onclick="closeLLMModal()">å…³é—­</button>
            <button class="llm-submit" onclick="handleLLMExport()">å¼€å§‹å¯¼å‡º</button>
        </div>
    </div>
</div>

<script>
    // Ensure Wails runtime is ready
    function checkRuntime() {
        if (!window.go || !window.go.main || !window.go.main.App) {
            console.warn("Wails runtime not ready yet.");
            return false;
        }
        return true;
    }

    function openLLMModal() {
        if (!checkRuntime()) {
            alert("ç¨‹åºå°šæœªå®Œå…¨åŠ è½½æˆ–æœªè¿æ¥åˆ°åç«¯ï¼Œè¯·ç¨åå†è¯•ã€‚\nå¦‚æœæŒç»­å‡ºç°æ­¤é—®é¢˜ï¼Œè¯·ç¡®ä¿æ‚¨å·²é‡æ–°ç¼–è¯‘å¹¶è¿è¡Œäº†æœ€æ–°ç‰ˆæœ¬ã€‚");
            return;
        }
        document.getElementById('llm-modal').style.display = 'block';
        loadContacts();
    }

    function closeLLMModal() {
        document.getElementById('llm-modal').style.display = 'none';
    }

    let allContacts = [];

    async function loadContacts() {
        const select = document.getElementById('llm-wxid');
        select.innerHTML = '<option value="">-- å¯¼å‡ºæ‰€æœ‰è”ç³»äºº (æ…ç”¨) --</option>';
        
        try {
            if (!checkRuntime()) return;
            
            // Get contacts, page 0 (start from 0), 500 items
            const resultStr = await window.go.main.App.GetWechatContactList(0, 500);
            console.log("Contacts loaded:", resultStr ? "Success" : "Empty");
            
            let result;
            try {
                result = JSON.parse(resultStr);
            } catch (e) {
                console.error("JSON parse error:", e);
                return;
            }
            
            if (result.Users && result.Users.length > 0) {
                allContacts = result.Users;
                renderContacts(allContacts);
            } else {
                const option = document.createElement('option');
                option.text = "(æœªæ‰¾åˆ°è”ç³»äººï¼Œè¯·å…ˆç™»å½•)";
                option.disabled = true;
                select.appendChild(option);
            }
        } catch (e) {
            console.error("Failed to load contacts", e);
            const option = document.createElement('option');
            option.text = "åŠ è½½å¤±è´¥: " + e;
            option.disabled = true;
            select.appendChild(option);
        }
    }

    function renderContacts(contacts) {
        const select = document.getElementById('llm-wxid');
        // Save current selection if any
        const currentVal = select.value;
        
        select.innerHTML = '<option value="">-- å¯¼å‡ºæ‰€æœ‰è”ç³»äºº (æ…ç”¨) --</option>';
        
        contacts.forEach(user => {
            const option = document.createElement('option');
            option.value = user.UserName;
            const name = user.ReMark || user.NickName || user.UserName;
            option.text = name;
            select.appendChild(option);
        });

        // Restore selection if still in list
        if (currentVal) {
            select.value = currentVal;
        }
    }

    function filterContacts() {
        const input = document.getElementById('llm-search');
        const filter = input.value.toLowerCase();
        
        const filtered = allContacts.filter(user => {
            const name = user.ReMark || user.NickName || user.UserName;
            return name.toLowerCase().includes(filter);
        });
        
        renderContacts(filtered);
    }

    async function handleLLMExport() {
        if (!checkRuntime()) return;

        const wxid = document.getElementById('llm-wxid').value;
        const prompt = document.getElementById('llm-prompt').value;
        const botName = document.getElementById('llm-botname').value;
        const gap = parseInt(document.getElementById('llm-gap').value) || 30;
        const clean = document.getElementById('llm-clean').checked;
        const path = document.getElementById('llm-path').value;

        if (!path) {
            alert("è¯·è¾“å…¥å¯¼å‡ºè·¯å¾„");
            return;
        }

        const btn = document.querySelector('.llm-submit');
        const originalText = btn.innerText;
        btn.innerText = "å¯¼å‡ºä¸­...";
        btn.disabled = true;

        try {
            console.log("Starting export...");
            const resultStr = await window.go.main.App.ExportLLMData(wxid, prompt, botName, gap, clean, path);
            console.log("Export result:", resultStr);
            
            let result;
            try {
                result = JSON.parse(resultStr);
            } catch (e) {
                throw new Error("Invalid JSON response: " + resultStr);
            }

            if (result.status === "success") {
                alert("å¯¼å‡ºæˆåŠŸï¼\næ–‡ä»¶å·²ä¿å­˜è‡³: " + path);
                closeLLMModal();
            } else {
                alert("å¯¼å‡ºå¤±è´¥: " + result.result);
            }
        } catch (e) {
            console.error("Export error:", e);
            alert("è°ƒç”¨å¤±è´¥: " + e);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('llm-modal');
        if (event.target == modal) {
            closeLLMModal();
        }
    }
</script>

</body>
</html>

